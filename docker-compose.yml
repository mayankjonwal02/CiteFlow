# ==========================================================================
# CITEFLOW - Docker Compose Service Orchestration
# AI-powered document suggestions with mandatory citations
# ==========================================================================
#
# Services:
#   1. recommendation-agent     - FastAPI app (port 8000)
#   2. qdrant-digitrix          - Vector database (port 6333)
#   3. searxng-digitrix         - Meta search engine (port 8080)
#   4. valkey-digitrix          - Redis-compatible cache for SearXNG (port 6379)
#   5. firecrawl-api-digitrix   - Web scraper API (port 3002) [built from source]
#   6. firecrawl-worker         - Firecrawl background worker
#   7. playwright-digitrix      - Browser rendering service (port 3000)
#   8. firecrawl-redis          - Redis for Firecrawl queue (port 6380)
#   9. firecrawl-rabbitmq       - RabbitMQ for Firecrawl jobs
#  10. nuq-postgres             - PostgreSQL for Firecrawl job queue
#
# Usage:
#   cp env.template .env
#   # Edit .env and set OPENAI_API_KEY
#   docker compose up -d
# ==========================================================================

services:
  # ── Recommendation Agent (Main Application) ──────────────────────────────
  recommendation-agent:
    build:
      context: ./Recommendation Agent
      dockerfile: Dockerfile
    container_name: recommendation-agent
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - QDRANT_URL=http://qdrant-digitrix:6333
      - SEARXNG_URL=http://searxng-digitrix:8080
      - FIRECRAWLER_URL=http://firecrawl-api-digitrix:3002
    depends_on:
      qdrant-digitrix:
        condition: service_healthy
      searxng-digitrix:
        condition: service_started
      firecrawl-api-digitrix:
        condition: service_started
    networks:
      - citeflow-network
    restart: unless-stopped

  # ── Qdrant Vector Database ───────────────────────────────────────────────
  qdrant-digitrix:
    image: qdrant/qdrant:v1.12.5
    container_name: qdrant-digitrix
    ports:
      - "6333:6333"
      - "6334:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    environment:
      - QDRANT__SERVICE__GRPC_PORT=6334
    healthcheck:
      test: ["CMD-SHELL", "bash -c ':> /dev/tcp/0.0.0.0/6333' || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - citeflow-network
    restart: unless-stopped

  # ── SearXNG Meta Search Engine ───────────────────────────────────────────
  searxng-digitrix:
    image: searxng/searxng:latest
    container_name: searxng-digitrix
    ports:
      - "8080:8080"
    volumes:
      - ./searxng-docker/searxng:/etc/searxng:rw
    environment:
      - SEARXNG_BASE_URL=http://localhost:8080/
    depends_on:
      valkey-digitrix:
        condition: service_healthy
    networks:
      - citeflow-network
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID

  # ── Valkey (Redis-compatible Cache for SearXNG) ─────────────────────────
  valkey-digitrix:
    image: valkey/valkey:8-alpine
    container_name: valkey-digitrix
    ports:
      - "6379:6379"
    volumes:
      - valkey-data:/data
    command: valkey-server --save 30 1 --loglevel warning
    healthcheck:
      test: ["CMD", "valkey-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - citeflow-network
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
      - DAC_OVERRIDE

  # ── Firecrawl Redis (Queue/Cache for Firecrawl) ─────────────────────────
  firecrawl-redis:
    image: redis:alpine
    container_name: firecrawl-redis-digitrix
    command: redis-server --bind 0.0.0.0
    networks:
      - citeflow-network
    restart: unless-stopped

  # ── Firecrawl RabbitMQ (Message Broker) ──────────────────────────────────
  firecrawl-rabbitmq:
    image: rabbitmq:3-management
    container_name: firecrawl-rabbitmq-digitrix
    networks:
      - citeflow-network
    command: rabbitmq-server
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "check_running"]
      interval: 5s
      timeout: 5s
      retries: 3
      start_period: 5s
    restart: unless-stopped

  # ── Firecrawl PostgreSQL (Job Queue) ─────────────────────────────────────
  nuq-postgres:
    build:
      context: ./firecrawl/apps/nuq-postgres
    container_name: nuq-postgres-digitrix
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    networks:
      - citeflow-network
    restart: unless-stopped

  # ── Playwright Browser Service (for Firecrawl JS rendering) ──────────────
  playwright-digitrix:
    build:
      context: ./firecrawl/apps/playwright-service-ts
    container_name: playwright-digitrix
    ports:
      - "3000:3000"
    environment:
      - PORT=3000
      - PROXY_SERVER=
      - PROXY_USERNAME=
      - PROXY_PASSWORD=
      - BLOCK_MEDIA=true
      - MAX_CONCURRENT_PAGES=10
    networks:
      - citeflow-network
    restart: unless-stopped
    cpus: 2.0
    mem_limit: 4G
    memswap_limit: 4G
    tmpfs:
      - /tmp/.cache:noexec,nosuid,size=1g

  # ── Firecrawl API (Web Scraper) ──────────────────────────────────────────
  firecrawl-api-digitrix:
    build:
      context: ./firecrawl/apps/api
    container_name: firecrawl-api-digitrix
    ports:
      - "3002:3002"
    environment:
      - HOST=0.0.0.0
      - PORT=3002
      - NUM_WORKERS_PER_QUEUE=8
      - REDIS_URL=redis://firecrawl-redis:6379
      - REDIS_RATE_LIMIT_URL=redis://firecrawl-redis:6379
      - PLAYWRIGHT_MICROSERVICE_URL=http://playwright-digitrix:3000/scrape
      - USE_DB_AUTHENTICATION=${USE_DB_AUTHENTICATION:-false}
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_HOST=nuq-postgres-digitrix
      - POSTGRES_PORT=5432
      - NUQ_RABBITMQ_URL=amqp://firecrawl-rabbitmq:5672
      - BULL_AUTH_KEY=@]citeflow2024
      - LOGGING_LEVEL=INFO
      - SUPABASE_ANON_TOKEN=
      - SUPABASE_URL=
      - SUPABASE_SERVICE_TOKEN=
      - TEST_API_KEY=
      - SELF_HOSTED_WEBHOOK_URL=
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      firecrawl-redis:
        condition: service_started
      playwright-digitrix:
        condition: service_started
      firecrawl-rabbitmq:
        condition: service_healthy
    networks:
      - citeflow-network
    restart: unless-stopped
    ulimits:
      nofile:
        soft: 65535
        hard: 65535
    command: ["node", "dist/src/harness.js", "--start-docker"]
    cpus: 4.0
    mem_limit: 8G
    memswap_limit: 8G

# ── Networks ───────────────────────────────────────────────────────────────
networks:
  citeflow-network:
    driver: bridge
    name: citeflow-network

# ── Volumes ────────────────────────────────────────────────────────────────
volumes:
  qdrant-data:
    name: citeflow-qdrant-data
  valkey-data:
    name: citeflow-valkey-data
